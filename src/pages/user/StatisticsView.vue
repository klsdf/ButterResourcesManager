<template>
  <div class="statistics-view">
    <div class="statistics-content">

      
      <div class="statistics-body">
        <!-- åª’ä½“æ•°é‡æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸ“ˆ åª’ä½“æ•°é‡æ€»è§ˆ</h5>
          <div class="stats-grid">
            <div class="stat-card" :class="{ loading: isLoading }" v-for="stat in mediaStats" :key="stat.type">
              <div class="stat-icon">{{ stat.icon }}</div>
              <div class="stat-info">
                <div class="stat-number">{{ isLoading ? '...' : stat.count }}</div>
                <div class="stat-label">{{ stat.label }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æ¸¸æˆæ•°æ®æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸ® æ¸¸æˆæ•°æ®æ€»è§ˆ</h5>
          <div class="media-overview-grid">
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ“Š</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : gameStats.count }}</div>
                <div class="media-overview-label">æ¸¸æˆæ€»æ•°</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ’¾</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : gameStats.storage }}</div>
                <div class="media-overview-label">ç©ºé—´å ç”¨</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">â±ï¸</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : gameStats.totalTime }}</div>
                <div class="media-overview-label">æ€»æ¸¸æˆæ—¶é•¿</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ¯</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : gameStats.playedCount }}</div>
                <div class="media-overview-label">å·²å¯åŠ¨æ¸¸æˆ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å›¾ç‰‡æ•°æ®æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸ–¼ï¸ å›¾ç‰‡æ•°æ®æ€»è§ˆ</h5>
          <div class="media-overview-grid">
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ“Š</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : imageStats.count }}</div>
                <div class="media-overview-label">å›¾ç‰‡æ€»æ•°</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ’¾</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : imageStats.storage }}</div>
                <div class="media-overview-label">ç©ºé—´å ç”¨</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ‘†</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : imageStats.clickCount }}</div>
                <div class="media-overview-label">ç‚¹å‡»æ¬¡æ•°</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è§†é¢‘æ•°æ®æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸ¬ è§†é¢‘æ•°æ®æ€»è§ˆ</h5>
          <div class="media-overview-grid">
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ“Š</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : videoStats.count }}</div>
                <div class="media-overview-label">è§†é¢‘æ€»æ•°</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ’¾</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : videoStats.storage }}</div>
                <div class="media-overview-label">ç©ºé—´å ç”¨</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ‘†</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : videoStats.clickCount }}</div>
                <div class="media-overview-label">ç‚¹å‡»æ¬¡æ•°</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å°è¯´æ•°æ®æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸ“š å°è¯´æ•°æ®æ€»è§ˆ</h5>
          <div class="media-overview-grid">
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ“Š</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : novelStats.count }}</div>
                <div class="media-overview-label">å°è¯´æ€»æ•°</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ’¾</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : novelStats.storage }}</div>
                <div class="media-overview-label">ç©ºé—´å ç”¨</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç½‘ç«™æ•°æ®æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸŒ ç½‘ç«™æ•°æ®æ€»è§ˆ</h5>
          <div class="media-overview-grid">
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ“Š</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : websiteStats.count }}</div>
                <div class="media-overview-label">ç½‘ç«™æ€»æ•°</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ’¾</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : websiteStats.storage }}</div>
                <div class="media-overview-label">ç©ºé—´å ç”¨</div>
              </div>
            </div>
          </div>
        </div>

        <!-- éŸ³é¢‘æ•°æ®æ€»è§ˆ -->
        <div class="statistics-section">
          <h5>ğŸµ éŸ³é¢‘æ•°æ®æ€»è§ˆ</h5>
          <div class="media-overview-grid">
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ“Š</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : audioStats.count }}</div>
                <div class="media-overview-label">éŸ³é¢‘æ€»æ•°</div>
              </div>
            </div>
            <div class="media-overview-card">
              <div class="media-overview-icon">ğŸ’¾</div>
              <div class="media-overview-info">
                <div class="media-overview-number">{{ isLoading ? '...' : audioStats.storage }}</div>
                <div class="media-overview-label">ç©ºé—´å ç”¨</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœˆåº¦æŠ¥å‘Š -->
        <div class="statistics-section">
          <h5>ğŸ“… æœˆåº¦æŠ¥å‘Š</h5>
          <div class="report-container">
            <div class="report-header">
              <div class="report-title">
                <h6>{{ currentMonthReport.title }}</h6>
                <p>{{ currentMonthReport.subtitle }}</p>
              </div>
              <div class="report-actions">
                <button @click="refreshMonthlyReport" class="refresh-btn" :disabled="isLoadingReport">
                  <span class="btn-icon">ğŸ”„</span>
                  <span>åˆ·æ–°</span>
                </button>
              </div>
            </div>
            
            <div class="report-content">
              <!-- ä½¿ç”¨æ¦‚è§ˆ -->
              <div class="report-section">
                <h7>ğŸ“Š ä½¿ç”¨æ¦‚è§ˆ</h7>
                <div class="overview-grid">
                  <div class="overview-item">
                    <div class="overview-number">{{ currentMonthReport.overview.newMediaCount }}</div>
                    <div class="overview-label">æ–°å¢åª’ä½“</div>
                  </div>
                  <div class="overview-item">
                    <div class="overview-number">{{ currentMonthReport.overview.totalUsageTime }}</div>
                    <div class="overview-label">æ€»ä½¿ç”¨æ—¶é•¿</div>
                  </div>
                  <div class="overview-item">
                    <div class="overview-number">{{ currentMonthReport.overview.mostActiveDay }}</div>
                    <div class="overview-label">æœ€æ´»è·ƒæ—¥æœŸ</div>
                  </div>
                </div>
              </div>

              <!-- åª’ä½“åˆ†æ -->
              <div class="report-section">
                <h7>ğŸ“ˆ åª’ä½“åˆ†æ</h7>
                <div class="analysis-grid">
                  <div class="analysis-card">
                    <div class="analysis-title">æœ€å¸¸è®¿é—®ç±»å‹</div>
                    <div class="analysis-value">{{ currentMonthReport.analysis.mostAccessedType }}</div>
                  </div>
                  <div class="analysis-card">
                    <div class="analysis-title">æ–°å¢æ”¶è—æœ€å¤š</div>
                    <div class="analysis-value">{{ currentMonthReport.analysis.mostAddedType }}</div>
                  </div>
                  <div class="analysis-card">
                    <div class="analysis-title">å­˜å‚¨ä½¿ç”¨</div>
                    <div class="analysis-value">{{ currentMonthReport.analysis.storageUsage }}</div>
                  </div>
                </div>
              </div>

              <!-- æ´»åŠ¨ç»Ÿè®¡ -->
              <div class="report-section">
                <h7>ğŸ¯ æ´»åŠ¨ç»Ÿè®¡</h7>
                <div class="activity-list">
                  <div class="activity-item" v-for="activity in currentMonthReport.activities" :key="activity.type">
                    <div class="activity-icon">{{ activity.icon }}</div>
                    <div class="activity-info">
                      <div class="activity-name">{{ activity.name }}</div>
                      <div class="activity-stats">{{ activity.stats }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</template>

<script>
import saveManager from '../../utils/SaveManager.ts'

export default {
  name: 'StatisticsView',
  data() {
    return {
      mediaStats: [
        { type: 'games', label: 'æ¸¸æˆ', icon: 'ğŸ®', count: 0 },
        { type: 'images', label: 'å›¾ç‰‡', icon: 'ğŸ–¼ï¸', count: 0 },
        { type: 'videos', label: 'è§†é¢‘', icon: 'ğŸ¬', count: 0 },
        { type: 'novels', label: 'å°è¯´', icon: 'ğŸ“š', count: 0 },
        { type: 'websites', label: 'ç½‘ç«™', icon: 'ğŸŒ', count: 0 },
        { type: 'audios', label: 'éŸ³é¢‘', icon: 'ğŸµ', count: 0 }
      ],
      isLoading: true,
      isLoadingReport: false,
      // å„åª’ä½“ç±»å‹çš„è¯¦ç»†ç»Ÿè®¡
      gameStats: {
        count: 0,
        storage: '0B',
        totalTime: '0å°æ—¶',
        playedCount: 0
      },
      imageStats: {
        count: 0,
        storage: '0B',
        clickCount: 0
      },
      videoStats: {
        count: 0,
        storage: '0B',
        clickCount: 0
      },
      novelStats: {
        count: 0,
        storage: '0B'
      },
      websiteStats: {
        count: 0,
        storage: '0B'
      },
      audioStats: {
        count: 0,
        storage: '0B'
      },
      currentMonthReport: {
        title: '',
        subtitle: '',
        overview: {
          newMediaCount: 0,
          totalUsageTime: '0å°æ—¶',
          mostActiveDay: 'æš‚æ— æ•°æ®'
        },
        analysis: {
          mostAccessedType: 'æš‚æ— æ•°æ®',
          mostAddedType: 'æš‚æ— æ•°æ®',
          storageUsage: '0GB'
        },
        activities: []
      }
    }
  },
  methods: {
    async loadMediaStatistics() {
      try {
        this.isLoading = true
        console.log('å¼€å§‹åŠ è½½åª’ä½“ç»Ÿè®¡æ•°æ®...')
        
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰åª’ä½“æ•°æ®
        const [games, images, videos, novels, websites, audios] = await Promise.all([
          saveManager.loadGames(),
          saveManager.loadImages(),
          saveManager.loadVideos(),
          saveManager.loadNovels(),
          saveManager.loadWebsites(),
          saveManager.loadAudios()
        ])
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        this.updateMediaCount('games', games.length)
        this.updateMediaCount('images', images.length)
        this.updateMediaCount('videos', videos.length)
        this.updateMediaCount('novels', novels.length)
        this.updateMediaCount('websites', websites.length)
        this.updateMediaCount('audios', audios.length)
        
        // è®¡ç®—å„åª’ä½“ç±»å‹çš„è¯¦ç»†ç»Ÿè®¡
        this.calculateDetailedStats(games, images, videos, novels, websites, audios)
        
        console.log('åª’ä½“ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ:', {
          æ¸¸æˆ: games.length,
          å›¾ç‰‡: images.length,
          è§†é¢‘: videos.length,
          å°è¯´: novels.length,
          ç½‘ç«™: websites.length,
          éŸ³é¢‘: audios.length
        })
        
      } catch (error) {
        console.error('åŠ è½½åª’ä½“ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        this.mediaStats.forEach(stat => {
          stat.count = '?'
        })
      } finally {
        this.isLoading = false
      }
    },
    updateMediaCount(type, count) {
      const stat = this.mediaStats.find(s => s.type === type)
      if (stat) {
        stat.count = count
      }
    },
    async refreshStatistics() {
      await this.loadMediaStatistics()
    },
    calculateDetailedStats(games, images, videos, novels, websites, audios) {
      // æ¸¸æˆç»Ÿè®¡
      this.gameStats = {
        count: games.length,
        storage: this.calculateMediaStorage('games', games),
        totalTime: this.calculateTotalGameTime(games),
        playedCount: games.filter(g => g.playCount > 0).length
      }
      
      // å›¾ç‰‡ç»Ÿè®¡
      this.imageStats = {
        count: images.length,
        storage: this.calculateMediaStorage('images', images),
        clickCount: this.calculateClickCount(images)
      }
      
      // è§†é¢‘ç»Ÿè®¡
      this.videoStats = {
        count: videos.length,
        storage: this.calculateMediaStorage('videos', videos),
        clickCount: this.calculateClickCount(videos)
      }
      
      // å°è¯´ç»Ÿè®¡
      this.novelStats = {
        count: novels.length,
        storage: this.calculateMediaStorage('novels', novels)
      }
      
      // ç½‘ç«™ç»Ÿè®¡
      this.websiteStats = {
        count: websites.length,
        storage: this.calculateMediaStorage('websites', websites)
      }
      
      // éŸ³é¢‘ç»Ÿè®¡
      this.audioStats = {
        count: audios.length,
        storage: this.calculateMediaStorage('audios', audios)
      }
    },
    calculateMediaStorage(type, mediaList) {
      let totalBytes = 0
      
      mediaList.forEach(item => {
        if (type === 'games' && item.folderSize) {
          // æ¸¸æˆä½¿ç”¨çœŸå®çš„æ–‡ä»¶å¤¹å¤§å°
          totalBytes += item.folderSize
        } else {
          // å…¶ä»–åª’ä½“ç±»å‹ä½¿ç”¨ä¼°ç®—å¤§å°
          const estimatedSizes = {
            'images': 5 * 1024 * 1024,    // å›¾ç‰‡: 5MB
            'videos': 500 * 1024 * 1024,  // è§†é¢‘: 500MB
            'novels': 2 * 1024 * 1024,    // å°è¯´: 2MB
            'websites': 0,                 // ç½‘ç«™: 0MB (åªæ˜¯é“¾æ¥)
            'audios': 10 * 1024 * 1024    // éŸ³é¢‘: 10MB
          }
          totalBytes += estimatedSizes[type] || 0
        }
      })
      
      return this.formatBytes(totalBytes)
    },
    calculateClickCount(mediaList) {
      let totalClicks = 0
      mediaList.forEach(item => {
        if (item.clickCount) {
          totalClicks += item.clickCount
        }
      })
      return totalClicks
    },
    calculateTotalStorageUsage(allMedia) {
      let totalBytes = 0
      
      allMedia.forEach((mediaList, index) => {
        mediaList.forEach(item => {
          // æ¸¸æˆä½¿ç”¨ folderSize å­—æ®µ
          if (index === 0 && item.folderSize) { // games
            totalBytes += item.folderSize
          } else {
            // å…¶ä»–åª’ä½“ç±»å‹ä½¿ç”¨ä¼°ç®—å¤§å°
            const estimatedSizes = {
              1: 5 * 1024 * 1024,    // å›¾ç‰‡: 5MB
              2: 500 * 1024 * 1024,  // è§†é¢‘: 500MB
              3: 2 * 1024 * 1024,    // å°è¯´: 2MB
              4: 0,                   // ç½‘ç«™: 0MB (åªæ˜¯é“¾æ¥)
              5: 10 * 1024 * 1024    // éŸ³é¢‘: 10MB
            }
            totalBytes += estimatedSizes[index] || 0
          }
        })
      })
      
      return this.formatBytes(totalBytes)
    },
    calculateTotalGameTime(games) {
      let totalSeconds = 0
      games.forEach(game => {
        if (game.playTime) {
          totalSeconds += game.playTime
        }
      })
      
      return this.formatTime(totalSeconds)
    },
    formatBytes(bytes) {
      if (bytes === 0) return '0B'
      
      const k = 1024
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB']
      const i = Math.floor(Math.log(bytes) / Math.log(k))
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i]
    },
    formatTime(totalSeconds) {
      if (totalSeconds === 0) return '0åˆ†é’Ÿ'
      
      const hours = Math.floor(totalSeconds / 3600)
      const minutes = Math.floor((totalSeconds % 3600) / 60)
      const seconds = totalSeconds % 60
      
      if (hours > 0) {
        if (minutes > 0) {
          return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`
        } else {
          return `${hours}å°æ—¶`
        }
      } else if (minutes > 0) {
        return `${minutes}åˆ†é’Ÿ`
      } else {
        return `${seconds}ç§’`
      }
    },
    async generateMonthlyReport() {
      try {
        this.isLoadingReport = true
        console.log('å¼€å§‹ç”Ÿæˆæœˆåº¦æŠ¥å‘Š...')
        
        // è·å–å½“å‰æœˆä»½ä¿¡æ¯
        const now = new Date()
        const currentYear = now.getFullYear()
        const currentMonth = now.getMonth() + 1
        const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                           'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ']
        
        // è®¾ç½®æŠ¥å‘Šæ ‡é¢˜
        this.currentMonthReport.title = `${currentYear}å¹´${monthNames[currentMonth - 1]}æœˆåº¦æŠ¥å‘Š`
        this.currentMonthReport.subtitle = `æ•°æ®ç»Ÿè®¡æ—¶é—´ï¼š${currentYear}å¹´${currentMonth}æœˆ1æ—¥ - ${now.getDate()}æ—¥`
        
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰åª’ä½“æ•°æ®
        const [games, images, videos, novels, websites, audios] = await Promise.all([
          saveManager.loadGames(),
          saveManager.loadImages(),
          saveManager.loadVideos(),
          saveManager.loadNovels(),
          saveManager.loadWebsites(),
          saveManager.loadAudios()
        ])
        
        // è®¡ç®—æœ¬æœˆæ–°å¢åª’ä½“æ•°é‡
        const currentMonthStart = new Date(currentYear, currentMonth - 1, 1)
        const newMediaCount = this.calculateNewMediaCount([games, images, videos, novels, websites, audios], currentMonthStart)
        
        // è®¡ç®—ä½¿ç”¨æ—¶é•¿ï¼ˆåŸºäºæ¸¸æˆæ—¶é•¿ï¼‰
        const totalUsageTime = this.calculateTotalUsageTime(games)
        
        // è®¡ç®—æœ€æ´»è·ƒæ—¥æœŸï¼ˆåŸºäºæ·»åŠ æ—¶é—´ï¼‰
        const mostActiveDay = this.calculateMostActiveDay([games, images, videos, novels, websites, audios], currentMonthStart)
        
        // åˆ†æåª’ä½“ç±»å‹
        const analysis = this.analyzeMediaTypes([games, images, videos, novels, websites, audios], currentMonthStart)
        
        // ç”Ÿæˆæ´»åŠ¨ç»Ÿè®¡
        const activities = this.generateActivityStats([games, images, videos, novels, websites, audios])
        
        // æ›´æ–°æŠ¥å‘Šæ•°æ®
        this.currentMonthReport.overview = {
          newMediaCount,
          totalUsageTime,
          mostActiveDay
        }
        
        this.currentMonthReport.analysis = analysis
        this.currentMonthReport.activities = activities
        
        console.log('æœˆåº¦æŠ¥å‘Šç”Ÿæˆå®Œæˆ:', this.currentMonthReport)
        
      } catch (error) {
        console.error('ç”Ÿæˆæœˆåº¦æŠ¥å‘Šå¤±è´¥:', error)
      } finally {
        this.isLoadingReport = false
      }
    },
    calculateNewMediaCount(allMedia, monthStart) {
      let totalNew = 0
      allMedia.forEach(mediaList => {
        mediaList.forEach(item => {
          if (item.addedDate) {
            const addedDate = new Date(item.addedDate)
            if (addedDate >= monthStart) {
              totalNew++
            }
          }
        })
      })
      return totalNew
    },
    calculateTotalUsageTime(games) {
      let totalSeconds = 0
      games.forEach(game => {
        if (game.playTime) {
          totalSeconds += game.playTime
        }
      })
      
      const hours = Math.floor(totalSeconds / 3600)
      const minutes = Math.floor((totalSeconds % 3600) / 60)
      
      if (hours > 0) {
        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`
      } else {
        return `${minutes}åˆ†é’Ÿ`
      }
    },
    calculateMostActiveDay(allMedia, monthStart) {
      const dayCounts = {}
      let maxCount = 0
      let mostActiveDay = 'æš‚æ— æ•°æ®'
      
      allMedia.forEach(mediaList => {
        mediaList.forEach(item => {
          if (item.addedDate) {
            const addedDate = new Date(item.addedDate)
            if (addedDate >= monthStart) {
              const day = addedDate.getDate()
              dayCounts[day] = (dayCounts[day] || 0) + 1
              if (dayCounts[day] > maxCount) {
                maxCount = dayCounts[day]
                mostActiveDay = `${addedDate.getMonth() + 1}æœˆ${day}æ—¥`
              }
            }
          }
        })
      })
      
      return mostActiveDay
    },
    analyzeMediaTypes(allMedia, monthStart) {
      const typeLabels = ['æ¸¸æˆ', 'å›¾ç‰‡', 'è§†é¢‘', 'å°è¯´', 'ç½‘ç«™', 'éŸ³é¢‘']
      const typeCounts = [0, 0, 0, 0, 0, 0]
      const newCounts = [0, 0, 0, 0, 0, 0]
      
      allMedia.forEach((mediaList, index) => {
        typeCounts[index] = mediaList.length
        mediaList.forEach(item => {
          if (item.addedDate) {
            const addedDate = new Date(item.addedDate)
            if (addedDate >= monthStart) {
              newCounts[index]++
            }
          }
        })
      })
      
      // æ‰¾åˆ°æœ€å¸¸è®¿é—®çš„ç±»å‹ï¼ˆæ€»æ•°æœ€å¤šï¼‰
      const maxTotalIndex = typeCounts.indexOf(Math.max(...typeCounts))
      const mostAccessedType = typeLabels[maxTotalIndex] || 'æš‚æ— æ•°æ®'
      
      // æ‰¾åˆ°æ–°å¢æœ€å¤šçš„ç±»å‹
      const maxNewIndex = newCounts.indexOf(Math.max(...newCounts))
      const mostAddedType = typeLabels[maxNewIndex] || 'æš‚æ— æ•°æ®'
      
      // è®¡ç®—å­˜å‚¨ä½¿ç”¨ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
      const totalItems = typeCounts.reduce((sum, count) => sum + count, 0)
      const storageUsage = totalItems > 0 ? `${(totalItems * 0.1).toFixed(1)}GB` : '0GB'
      
      return {
        mostAccessedType,
        mostAddedType,
        storageUsage
      }
    },
    generateActivityStats(allMedia) {
      const [games, images, videos, novels, websites, audios] = allMedia
      
      return [
        {
          type: 'games',
          name: 'æ¸¸æˆå¯åŠ¨',
          icon: 'ğŸ®',
          stats: `${games.filter(g => g.playCount > 0).length}ä¸ªæ¸¸æˆè¢«å¯åŠ¨`
        },
        {
          type: 'videos',
          name: 'è§†é¢‘è§‚çœ‹',
          icon: 'ğŸ¬',
          stats: `${videos.length}ä¸ªè§†é¢‘æ”¶è—`
        },
        {
          type: 'audios',
          name: 'éŸ³é¢‘æ’­æ”¾',
          icon: 'ğŸµ',
          stats: `${audios.length}ä¸ªéŸ³é¢‘æ”¶è—`
        },
        {
          type: 'novels',
          name: 'å°è¯´é˜…è¯»',
          icon: 'ğŸ“š',
          stats: `${novels.length}æœ¬å°è¯´æ”¶è—`
        },
        {
          type: 'images',
          name: 'å›¾ç‰‡æµè§ˆ',
          icon: 'ğŸ–¼ï¸',
          stats: `${images.length}å¼ å›¾ç‰‡æ”¶è—`
        },
        {
          type: 'websites',
          name: 'ç½‘ç«™è®¿é—®',
          icon: 'ğŸŒ',
          stats: `${websites.length}ä¸ªç½‘ç«™æ”¶è—`
        }
      ]
    },
    async refreshMonthlyReport() {
      await this.generateMonthlyReport()
    }
  },
  async mounted() {
    console.log('ç»Ÿè®¡é¡µé¢å·²åŠ è½½')
    await this.loadMediaStatistics()
    await this.generateMonthlyReport()
  }
}
</script>

<style scoped>
.statistics-view {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.statistics-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.statistics-body {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.placeholder-content {
  text-align: center;
  color: var(--text-secondary);
  max-width: 500px;
}

.placeholder-icon {
  font-size: 3rem;
  margin-bottom: 16px;
  opacity: 0.6;
}

.placeholder-content h5 {
  margin: 0 0 12px 0;
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--text-primary);
}

.placeholder-content p {
  margin: 0 0 24px 0;
  font-size: 0.9rem;
  opacity: 0.8;
}


/* ç»Ÿè®¡åŒºåŸŸæ ·å¼ */
.statistics-section {
  margin-bottom: 32px;
}

.statistics-section h5 {
  margin: 0 0 16px 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
}

/* ç»Ÿè®¡ç½‘æ ¼æ ·å¼ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  display: flex;
  align-items: center;
  padding: 20px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  background: var(--bg-hover);
  border-color: var(--accent-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-color), var(--accent-color-light));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-icon {
  font-size: 2.5rem;
  margin-right: 16px;
  opacity: 0.8;
  transition: transform 0.3s ease;
}

.stat-card:hover .stat-icon {
  transform: scale(1.1);
}

.stat-info {
  flex: 1;
}

.stat-number {
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-color);
  line-height: 1;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* åŠ è½½çŠ¶æ€ */
.stat-card.loading .stat-number {
  color: var(--text-secondary);
  opacity: 0.6;
}

.stat-card.loading .stat-icon {
  opacity: 0.4;
}

/* åª’ä½“æ€»è§ˆç½‘æ ¼æ ·å¼ */
.media-overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.media-overview-card {
  display: flex;
  align-items: center;
  padding: 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.media-overview-card:hover {
  background: var(--bg-hover);
  border-color: var(--accent-color);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.media-overview-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent-color), var(--accent-color-light));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.media-overview-card:hover::before {
  opacity: 1;
}

.media-overview-icon {
  font-size: 1.8rem;
  margin-right: 12px;
  opacity: 0.8;
  transition: transform 0.3s ease;
}

.media-overview-card:hover .media-overview-icon {
  transform: scale(1.05);
}

.media-overview-info {
  flex: 1;
}

.media-overview-number {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--accent-color);
  line-height: 1;
  margin-bottom: 2px;
}

.media-overview-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* æœˆåº¦æŠ¥å‘Šæ ·å¼ */
.report-container {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.report-container:hover {
  border-color: var(--accent-color);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.report-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
}

.report-title h6 {
  margin: 0 0 4px 0;
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
}

.report-title p {
  margin: 0;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.report-actions {
  display: flex;
  gap: 8px;
}

.refresh-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: var(--accent-color);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.refresh-btn:hover:not(:disabled) {
  background: var(--accent-color-dark);
  transform: translateY(-1px);
}

.refresh-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-icon {
  font-size: 0.9rem;
}

.report-content {
  padding: 20px;
}

.report-section {
  margin-bottom: 24px;
}

.report-section:last-child {
  margin-bottom: 0;
}

.report-section h7 {
  display: block;
  margin: 0 0 12px 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* ä½¿ç”¨æ¦‚è§ˆæ ·å¼ */
.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 16px;
}

.overview-item {
  text-align: center;
  padding: 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: all 0.3s ease;
}

.overview-item:hover {
  background: var(--bg-hover);
  border-color: var(--accent-color);
}

.overview-number {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent-color);
  line-height: 1;
  margin-bottom: 4px;
}

.overview-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* åª’ä½“åˆ†ææ ·å¼ */
.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
}

.analysis-card {
  padding: 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: all 0.3s ease;
}

.analysis-card:hover {
  background: var(--bg-hover);
  border-color: var(--accent-color);
}

.analysis-title {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 500;
}

.analysis-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 600;
}

/* æ´»åŠ¨ç»Ÿè®¡æ ·å¼ */
.activity-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.activity-item {
  display: flex;
  align-items: center;
  padding: 12px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: all 0.3s ease;
}

.activity-item:hover {
  background: var(--bg-hover);
  border-color: var(--accent-color);
}

.activity-icon {
  font-size: 1.5rem;
  margin-right: 12px;
  opacity: 0.8;
}

.activity-info {
  flex: 1;
}

.activity-name {
  font-size: 0.9rem;
  color: var(--text-primary);
  font-weight: 500;
  margin-bottom: 2px;
}

.activity-stats {
  font-size: 0.8rem;
  color: var(--text-secondary);
}
</style>
